<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>com.gaumala.felec documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>com</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gaumala</span></div></div></li><li class="depth-3 current"><a href="com.gaumala.felec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>felec</span></div></a></li><li class="depth-4"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></div></li><li class="depth-5"><a href="com.gaumala.felec.db.h2.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>h2</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="com.gaumala.felec.html#var-check-autorizacion"><div class="inner"><span>check-autorizacion</span></div></a></li><li class="depth-1"><a href="com.gaumala.felec.html#var-create-factura"><div class="inner"><span>create-factura</span></div></a></li><li class="depth-1"><a href="com.gaumala.felec.html#var-insert-contribuyente"><div class="inner"><span>insert-contribuyente</span></div></a></li><li class="depth-1"><a href="com.gaumala.felec.html#var-send-comprobante"><div class="inner"><span>send-comprobante</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">com.gaumala.felec</h1><div class="doc"><div class="markdown"><p>API publico para generar comprobantes electrónicos, insertarlos a una base de datos local, enviarlos al SRI, y consultar su estado de autorización.</p>
<p>Todas estas funciones reciben como primer parámetro un mapa “contexto” con los sigientes campos:</p>
<table>
<thead>
<tr><th> key         </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:ds</code>       </td><td> <code>DataSource</code> para conectarse a la base de datos.</td></tr>
<tr><td> <code>:ambiente</code> </td><td> Ambiente a usar en los comprobantes electrónicos. 1 para pruebas y 2 para producción</td></tr>
<tr><td> <code>:aes-pwd</code>  </td><td> Contraseña para encriptar información personal en la base de datos.</td></tr>
</tbody>
</table>
<p>Este es un ejemplo de como crear un contexto con conexión a una base de datos H2 en ambiente de pruebas:</p>
<pre><code class="language-clojure">(require '[com.gaumala.felec.db.h2 :as h2])
(def ctx {:ds (h2/get-ds "./.db") :ambiente 1 :aes-pwd "mypass1234"})
</code></pre>
</div></div><div class="public anchor" id="var-check-autorizacion"><h3>check-autorizacion</h3><div class="usage"><code>(check-autorizacion ctx ruc tipo codigo)</code></div><div class="doc"><div class="markdown"><p>Revisa el estado de la autorización de un comprobante en la base de datos a través del web service <code>autorizacionComprobante</code>. Los últimos tres parámetros son el RUC, tipo y código de 8 dígitos que identifican al comprobante en la base de datos. Devuelve la respuesta del SRI después de actualizar el estado del comprobante en la base de datos (“AUTORIZADO” o “DEVUELTA”).</p>
<p>Ten en cuenta que actualmente sólo soportamos el tipo  “factura”.</p>
<p>Este es un ejemplo de como consultar la autorización de una factura:</p>
<pre><code class="language-clojure">(require '[com.gaumala.felec :as felec])

(felec/check-autorizacion ctx "1792146739001" "factura" "00000001")
;; =&gt; {:claveAccesoConsultada "2410202401179214673900110020010000000010000000113"
;;     :numeroComprobantes "1"
;;     :autorizaciones [{:estado "AUTORIZADO"
;;                       :numeroAutorizacion "2410202401179214673900110020010000000010000000113"
;;                       :fechaAutorizacion "2024-10-24T13:03:17-05:00"
;;                       :ambiente "PRUEBAS"
;;                       :comprobante "..."}]}
</code></pre>
<p>Si ocurre algún error, se arroja un <code>ex-info</code> cuya data tendrá un key <code>:type</code> con uno de los siguientes valores:</p>
<table>
<thead>
<tr><th> type                     </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:bad-input</code>             </td><td> No se pudo encontrar esa combinación de RUC, tipo y código de 8 dígitos en la base de datos.</td></tr>
<tr><td> <code>:web-service-call</code>      </td><td> Se produjo un error al llamar al web service del SRI. Puedes consultar los campos <code>:url</code>, <code>:status</code>, y <code>:response</code> para mas información.</td></tr>
</tbody>
</table>
</div></div><div class="src-link"><a href="https://github.com/GAumala/felec/src/com/gaumala/felec.clj#L295">view source</a></div></div><div class="public anchor" id="var-create-factura"><h3>create-factura</h3><div class="usage"><code>(create-factura ctx {:keys [ruc codigo keystore-pwd]} input)</code></div><div class="doc"><div class="markdown"><p>Crea un nuevo comprobante de tipo factura (versión 1.0.0) en la base de datos. Para poder envíar un comprobante al SRI, debes primero tener el comprobante en la base de datos.</p>
<p>Cada comprobante debe tener una combinación única de RUC, tipo y código de 8 dígitos. Este código es el mismo que se usa para la clave de acceso.</p>
<p>El segundo parámetro es un mapa con los siguiente parámetros:</p>
<table>
<thead>
<tr><th> key             </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:ruc</code>          </td><td> El número de RUC del contribuyente. Requerido.</td></tr>
<tr><td> <code>:codigo</code>       </td><td> Código de 8 dígitos. Requerido.</td></tr>
<tr><td> <code>:keystore-pwd</code> </td><td> Contraseña del keystore para firmar el comprobante. Requerido.</td></tr>
</tbody>
</table>
<p>El tercer parámetro es un mapa con los datos de la factura, de acuerdo al spec <code>:felec/factura</code>. Este spec trata de ser idéntico al formato XML de las facturas del SRI, pero usando mapas de Clojure.</p>
<p>Este es un ejemplo de como crear una factura:</p>
<pre><code class="language-clojure">(require '[com.gaumala.felec :as felec])

(def factura
  {:infoTributaria {:secuencial "000000001"}
   :infoFactura {:fechaEmision "24/10/2024"
                 :tipoIdentificacionComprador "04"
                 :razonSocialComprador "PRUEBAS SERVICIO RENTAS INTERNAS"
                 :identificacionComprador "1713328506001"
                 :direccionComprador "salinas y santiago"
                 :totalSinImpuestos 200.0
                 :totalDescuento 0
                 :totalConImpuestos [{:codigo 2
                                    :codigoPorcentaje 4
                                    :baseImponible 200
                                    :valor 30}]
                 :propina 0
                 :importeTotal "230"
                 :pagos [{:formaPago "01"
                          :total 230
                          :plazo 30
                          :unidadTiempo "dias"}]}
   :detalles [{:codigoPrincipal "001"
               :descripcion "Servicios informaticos"
               :cantidad 1
               :precioUnitario 200
               :descuento 0
               :precioTotalSinImpuesto 200
               :impuestos [{:codigo 2
                            :codigoPorcentaje 4
                            :baseImponible 200
                            :valor 30
                            :tarifa 15}]}]})

(felec/create-factura ctx {:ruc "1792146739001"
                           :codigo "00000001"
                           :keystore-pwd  "my-keys-pwd12346"} factura)
</code></pre>
<p>En <code>:infoTributaria</code> no es necesario incluir todos los campos requeridos, ya que la base datos ya obtiene esos datos al insertar el contribuyente. Incluso el secuencial se puede puede omitir si ya tienes facturas en la base de datos. Simplemente se calcula el siguiente secuencial en base a tus facturas anteriores.</p>
<p>Si ocurre algún error, se arroja un <code>ex-info</code> cuya data tendrá un key <code>:type</code> con uno de los siguientes valores:</p>
<table>
<thead>
<tr><th> type                     </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:spec-validation</code>       </td><td> Estás ingresando parámetros inválidos en la función. Puedes revisar <code>:data</code> para una explicación.</td></tr>
<tr><td> <code>:bad-input</code>             </td><td> No se pudo encontrar un contribuyente en la base de datos con ese RUC.</td></tr>
<tr><td> <code>:xml-signature</code>         </td><td> No se pudo firmar el comprobante Quizas ingresaste mal <code>:keystore-pwd</code>, o tu keystore es inválido.</td></tr>
<tr><td> <code>:sql-unique-constraint</code> </td><td> Ya existe una factura con ese RUC y código de 8 dígitos.</td></tr>
<tr><td> <code>:secuencial-missing</code>    </td><td> Necesitas incluir el campo <code>:secuencial</code> en la factura.</td></tr>
</tbody>
</table>
</div></div><div class="src-link"><a href="https://github.com/GAumala/felec/src/com/gaumala/felec.clj#L162">view source</a></div></div><div class="public anchor" id="var-insert-contribuyente"><h3>insert-contribuyente</h3><div class="usage"><code>(insert-contribuyente ctx input)</code></div><div class="doc"><div class="markdown"><p>Inserta un nuevo contribuyente en la base de datos. Para poder emitir comprobantes, debes primero tener el contribuyente en la base de datos.</p>
<p>El mapa input necesita los siguiente parámetros:</p>
<table>
<thead>
<tr><th> key         </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:ruc</code>      </td><td> El número de RUC del contribuyente. Requerido.</td></tr>
<tr><td> <code>:keystore</code> </td><td> El keystore del contribuyente para firmar sus comprobantes. Puede ser una ruta a un archivo <code>.p12</code> o los bytes del archivo. Requerido.</td></tr>
<tr><td> <code>:datos</code>    </td><td> Un mapa con datos del contribuyente que se incluyen en todos los comprobantes. <code>:razonSocial</code> y <code>:dirMatriz</code> son obligatorios. Opcionalmente también puedes incluir <code>:estab</code>, <code>:ptoEmi</code>, <code>:nombreComercial</code>, <code>:dirEstablecimiento</code>, <code>:contribuyenteEspecial</code>, <code>:obligadoContabilidad</code> y <code>:moneda</code>. Requerido.</td></tr>
<tr><td> <code>:keystore-pwd</code> </td><td> Contraseña para acceder a las llaves privadas del keystore y poder firmar. Si incluyes este dato, Se realizará una firma con un documento de prueba. Si la firma falla se arroja una excepción antes de insertar el contribuyente. La contraseña nunca se guarda. Opcional.</td></tr>
</tbody>
</table>
<p>Este es un ejemplo de como insertar un contribuyente:</p>
<pre><code class="language-clojure">(require '[com.gaumala.felec :as felec])

(def datos {:razonSocial "Distribuidora de Suministros Nacional S.A."
                 :estab "002"
                 :ptoEmi "001"
                 :dirMatriz "Enrique Guerrero Portilla OE1-34 AV. Galo Plaza Lasso"
                 :dirEstablecimiento "Sebastián Moreno S/N Francisco García"
                 :contribuyenteEspecial "5368"
                 :obligadoContabilidad "SI"})
(felec/insert-contribuyente ctx {:ruc "1792146739001"
                                :keystore "/home/gabriel/Documents/mi_firma.p12"
                                :datos datos})
</code></pre>
<p>Si ocurre algún error, se arroja un <code>ex-info</code> cuya data tendrá un key <code>:type</code> con uno de los siguientes valores:</p>
<table>
<thead>
<tr><th> type                     </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:spec-validation</code>       </td><td> Estás ingresando parámetros inválidos en la función. Puedes revisar <code>:data</code> para una explicación</td></tr>
<tr><td> <code>:xml-signature</code>         </td><td> La firma del documento de prueba falló. Quizas ingresaste mal <code>:keystore-pwd</code>, o tu keystore es inválido.</td></tr>
<tr><td> <code>:sql-unique-constraint</code> </td><td> Ya existe un contribuyente con ese RUC.</td></tr>
</tbody>
</table>
</div></div><div class="src-link"><a href="https://github.com/GAumala/felec/src/com/gaumala/felec.clj#L116">view source</a></div></div><div class="public anchor" id="var-send-comprobante"><h3>send-comprobante</h3><div class="usage"><code>(send-comprobante ctx ruc tipo codigo)</code></div><div class="doc"><div class="markdown"><p>Envía un comprobante de la base de datos al SRI a través del web service <code>validarComprobante</code>. Los últimos tres parámetros son el RUC, tipo y código de 8 dígitos que identifican al comprobante en la base de datos. Devuelve la respuesta del SRI después de actualizar el estado del comprobante en la base de datos (“RECIBIDA” o “RECHAZADA”).</p>
<p>Ten en cuenta que actualmente sólo soportamos el tipo  “factura”.</p>
<p>Este es un ejemplo de como envíar una factura:</p>
<pre><code class="language-clojure">(require '[com.gaumala.felec :as felec])

(felec/send-comprobante ctx "1792146739001" "factura" "00000001")
;; =&gt; {:estado "RECIBIDA" mensajes ()}
</code></pre>
<p>Si ocurre algún error, se arroja un <code>ex-info</code> cuya data tendrá un key <code>:type</code> con uno de los siguientes valores:</p>
<table>
<thead>
<tr><th> type                     </th><th> Descripción </th></tr>
</thead>
<tbody>
<tr><td> <code>:bad-input</code>             </td><td> No se pudo encontrar esa combinación de RUC, tipo y código de 8 dígitos en la base de datos.</td></tr>
<tr><td> <code>:web-service-call</code>      </td><td> Se produjo un error al llamar al web service del SRI. Puedes consultar los campos <code>:url</code>, <code>:status</code>, y <code>:response</code> para mas información.</td></tr>
</tbody>
</table>
</div></div><div class="src-link"><a href="https://github.com/GAumala/felec/src/com/gaumala/felec.clj#L263">view source</a></div></div></div></body></html>